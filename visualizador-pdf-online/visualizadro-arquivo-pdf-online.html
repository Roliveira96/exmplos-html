<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de PDF com Efeito de Livro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #d1d5db;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            padding: 1rem;
        }
        #flipbook-container {
            perspective: 2000px;
        }
        #flipbook {
            width: 90vw;
            height: 85vh;
            max-width: 1200px;
            max-height: 750px;
        }
        #flipbook .page {
            background-color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            position: relative;
        }
        #flipbook .page canvas {
            width: 100%;
            height: 100%;
        }
        #loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        #zoom-content {
            cursor: grab;
        }
        #zoom-content.grabbing {
            cursor: grabbing;
        }
        .textLayer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            color: transparent;
            pointer-events: none;
            line-height: 1.0;
        }
        .textLayer > span {
            position: absolute;
            white-space: pre;
            transform-origin: 0% 0%;
        }
        .textLayer span.highlight {
            background-color: rgba(255, 255, 0, 0.8); 
            color: black !important;
        }
    </style>
</head>
<body>
    <div id="loading-message" class="bg-blue-100 p-4 rounded-lg shadow-xl text-lg text-gray-700">
        Carregando e renderizando as páginas do livro...
    </div>

    <div id="flipbook-container">
        <div id="flipbook"></div>
    </div>

    <div class="mt-2 flex items-center justify-center flex-wrap gap-4 z-10">
        <button id="prev-page" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-transform transform hover:scale-105">Anterior</button>
        <span id="page-info" class="text-gray-800 font-semibold"></span>
        <button id="next-page" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-transform transform hover:scale-105">Próxima</button>
        <button id="zoom-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-transform transform hover:scale-105">Lupa</button>
        <div class="flex items-center bg-white rounded-lg shadow-md">
            <input type="search" id="search-input" placeholder="Pesquisar..." class="py-2 px-3 border-none rounded-l-lg focus:outline-none">
            <button id="search-btn" class="bg-gray-800 text-white p-2.5 rounded-r-lg hover:bg-black">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>
            </button>
        </div>
    </div>
    <div id="search-results-container" class="mt-2 text-sm text-gray-700 w-full max-w-2xl h-8 text-center overflow-x-auto whitespace-nowrap"></div>

    <div id="zoom-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="zoom-content" class="bg-white p-2 rounded-lg shadow-2xl max-w-full max-h-full overflow-auto"></div>
        <div class="absolute top-4 right-4 flex items-center space-x-2">
            <button id="zoom-out-modal" class="bg-white text-gray-800 rounded-full py-1 px-3 text-2xl leading-none shadow-lg hover:bg-gray-200">-</button>
            <button id="zoom-in-modal" class="bg-white text-gray-800 rounded-full py-1 px-3 text-2xl leading-none shadow-lg hover:bg-gray-200">+</button>
            <button id="close-zoom" class="bg-white text-gray-800 rounded-full py-1 px-3 text-2xl leading-none shadow-lg hover:bg-gray-200">&times;</button>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
        const pdfUrl = 'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf';
        const scale = 1.5;

        const flipbook = $('#flipbook');
        const loadingMessage = $('#loading-message');
        const pageInfo = $('#page-info');
        
        let isFlipbookInitialized = false;
        let pdfDoc = null;
        let modalZoomLevel = 2.5;
        let pageTextContents = []; 
        let pendingHighlight = null;

        async function loadPdfAndInitFlipbook() {
            try {
                const loadingTask = pdfjsLib.getDocument(pdfUrl);
                pdfDoc = await loadingTask.promise;
                const numPages = pdfDoc.numPages;

                for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                    loadingMessage.text(`Processando página ${pageNum} de ${numPages}...`);
                    const page = await pdfDoc.getPage(pageNum);
                    const viewport = page.getViewport({ scale: scale });
                    
                    const pageElement = $('<div>').addClass('page').attr('data-page-number', pageNum);

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    pageElement.append(canvas);

                    const textLayerDiv = document.createElement('div');
                    textLayerDiv.className = 'textLayer';
                    pageElement.append(textLayerDiv);
                    
                    const renderContext = { canvasContext: ctx, viewport: viewport };
                    await page.render(renderContext).promise;
                    
                    const textContent = await page.getTextContent();
                    pageTextContents.push(textContent); 
                    
                    pdfjsLib.renderTextLayer({
                        textContent: textContent,
                        container: textLayerDiv,
                        viewport: viewport,
                        textDivs: []
                    });
                    
                    flipbook.append(pageElement);
                }

                // Oculta a mensagem de carregamento inicial
                setTimeout(() => {
                    loadingMessage.hide();
                }, 100);

                flipbook.turn({
                    width: flipbook.width(),
                    height: flipbook.height(),
                    autoCenter: true,
                    elevation: 50,
                    gradients: true,
                    when: {
                        turned: (event, page, view) => {
                            updatePageInfo();
                            clearHighlights();
                            if (pendingHighlight && view.includes(pendingHighlight.pageNum)) {
                                highlightWords(pendingHighlight.pageNum, pendingHighlight.term);
                                pendingHighlight = null;
                            }
                        }
                    }
                });
                
                isFlipbookInitialized = true;
                updatePageInfo();
            } catch (error) {
                console.error('Erro ao carregar o PDF:', error);
                loadingMessage.text('Falha ao carregar o PDF.').show();
                setTimeout(() => {
                    loadingMessage.hide();
                }, 3000);
            }
        }
        
        function updatePageInfo() {
            if (!isFlipbookInitialized) return;
            const currentPage = flipbook.turn('page');
            const totalPages = flipbook.turn('pages');
            pageInfo.text(`Página ${currentPage} de ${totalPages}`);
        }

        $('#prev-page').on('click', () => flipbook.turn('previous'));
        $('#next-page').on('click', () => flipbook.turn('next'));
        $(window).on('resize', () => { if (isFlipbookInitialized) flipbook.turn('size', flipbook.width(), flipbook.height()); });
        
        const searchInput = $('#search-input');
        const searchBtn = $('#search-btn');
        const searchResultsContainer = $('#search-results-container');

        function handleSearch() {
            const searchTerm = searchInput.val().trim();

            if (searchTerm.length < 2) {
                searchResultsContainer.text('');
                clearHighlights();
                return;
            }
            const searchResults = [];
            pageTextContents.forEach((textContent, pageIndex) => {
                const { fullText } = buildTextAndMap(textContent);
                if (fullText.toLowerCase().includes(searchTerm.toLowerCase())) {
                    searchResults.push(pageIndex + 1);
                }
            });
            displaySearchResults(searchResults, searchTerm);
        }

        function displaySearchResults(results, term) {
            searchResultsContainer.empty();
            if (results.length === 0) {
                searchResultsContainer.text(`Nenhum resultado encontrado para "${term}".`);
                return;
            }
            searchResultsContainer.append(`<span>${results.length} resultado(s) em: </span>`);
            results.forEach((pageNum) => {
                const pageLink = $(`<a href="#" class="text-blue-600 hover:underline cursor-pointer ml-2">${pageNum}</a>`);
                pageLink.on('click', (e) => {
                    e.preventDefault();
                    const view = flipbook.turn('view');
                    if (view.includes(pageNum)) {
                        highlightWords(pageNum, term);
                    } else {
                        pendingHighlight = { pageNum, term };
                        flipbook.turn('page', pageNum);
                    }
                });
                searchResultsContainer.append(pageLink);
            });
        }
        
        function buildTextAndMap(textContent) {
            let fullText = '';
            let charMap = [];
            const items = textContent.items;

            items.forEach((item, index) => {
                const textItem = item.str;
                
                for (let i = 0; i < textItem.length; i++) {
                    fullText += textItem[i];
                    charMap.push(index);
                }

                if (index < items.length - 1) {
                    const nextItem = items[index + 1];
                    if (textItem.length > 0 && textItem[textItem.length - 1] !== ' ' && nextItem.str.length > 0 && nextItem.str[0] !== ' ') {
                         fullText += ' ';
                         charMap.push(index); 
                    }
                }
            });
            
            return { fullText, charMap };
        }

        function highlightWords(pageNum, searchTerm) {
            clearHighlights();
            const pageIndex = pageNum - 1;
            if (pageIndex < 0 || pageIndex >= pageTextContents.length) return;

            const textContent = pageTextContents[pageIndex];
            const pageElement = flipbook.find(`.page[data-page-number="${pageNum}"]`);
            const textLayer = pageElement.find('.textLayer')[0];
            if (!textLayer) return;

            const allSpans = Array.from(textLayer.querySelectorAll('span'));
            if (allSpans.length === 0) return;

            const { fullText, charMap } = buildTextAndMap(textContent);
            const lowerFullText = fullText.toLowerCase();
            const lowerSearchTerm = searchTerm.toLowerCase();

            let startIndex = 0;
            
            while ((startIndex = lowerFullText.indexOf(lowerSearchTerm, startIndex)) !== -1) {
                const endIndex = startIndex + lowerSearchTerm.length;
                
                for (let i = startIndex; i < endIndex; i++) {
                    const spanIndex = charMap[i];
                    if (spanIndex !== undefined && spanIndex < allSpans.length) {
                        allSpans[spanIndex].classList.add('highlight');
                    }
                }
                startIndex = endIndex; 
            }
        }
        
        function clearHighlights() {
            $('.textLayer span').removeClass('highlight');
        }

        searchBtn.on('click', handleSearch);
        searchInput.on('keyup', (e) => { if (e.key === 'Enter') handleSearch(); });

        const zoomBtn = $('#zoom-btn');
        const zoomModal = $('#zoom-modal');
        const zoomContent = $('#zoom-content');
        const closeZoomBtn = $('#close-zoom');

        async function renderZoomedPages(zoomLevel) {
            if (!isFlipbookInitialized || !pdfDoc) return;
            zoomContent.empty();
            const view = flipbook.turn('view');
            
            loadingMessage.text('A aplicar zoom...').show();
            
            try {
                const canvasContainer = $('<div class="flex flex-col md:flex-row gap-2"></div>');
                for (const pageNum of view) {
                    if (pageNum === 0) continue;
                    const page = await pdfDoc.getPage(pageNum);
                    const viewport = page.getViewport({ scale: zoomLevel });
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    const renderContext = { canvasContext: ctx, viewport: viewport };
                    await page.render(renderContext).promise;
                    canvasContainer.append(canvas);
                }
                zoomContent.append(canvasContainer);
            } catch (error) {
                console.error("Erro ao aplicar zoom:", error);
                loadingMessage.text('Falha ao aplicar zoom.').show();
                setTimeout(() => loadingMessage.hide(), 2000); 
            } finally {
                // Esconde a mensagem de loading de forma garantida e reseta o texto padrão.
                setTimeout(() => {
                    loadingMessage.hide();
                    loadingMessage.text('Carregando e renderizando as páginas do livro...');
                }, 100);
            }
        }

        zoomBtn.on('click', () => {
            renderZoomedPages(modalZoomLevel);
            zoomModal.removeClass('hidden').addClass('flex');
        });

        $('#zoom-in-modal').on('click', () => {
            modalZoomLevel = Math.min(5.0, modalZoomLevel + 0.5);
            renderZoomedPages(modalZoomLevel);
        });

        $('#zoom-out-modal').on('click', () => {
            modalZoomLevel = Math.max(1.0, modalZoomLevel - 0.5);
            renderZoomedPages(modalZoomLevel);
        });

        closeZoomBtn.on('click', () => {
            zoomModal.addClass('hidden').removeClass('flex');
            zoomContent.empty();
        });
        
        let isPanning = false;
        let startX, startY, scrollLeft, scrollTop;
        zoomContent.on('mousedown', (e) => { isPanning = true; zoomContent.addClass('grabbing'); startX = e.pageX - zoomContent.offset().left; startY = e.pageY - zoomContent.offset().top; scrollLeft = zoomContent.scrollLeft(); scrollTop = zoomContent.scrollTop(); });
        zoomContent.on('mouseleave', () => { isPanning = false; zoomContent.removeClass('grabbing'); });
        zoomContent.on('mouseup', () => { isPanning = false; zoomContent.removeClass('grabbing'); });
        zoomContent.on('mousemove', (e) => { if (!isPanning) return; e.preventDefault(); const x = e.pageX - zoomContent.offset().left; const y = e.pageY - zoomContent.offset().top; const walkX = (x - startX); const walkY = (y - startY); zoomContent.scrollLeft(scrollLeft - walkX); zoomContent.scrollTop(scrollTop - walkY); });

        $(document).ready(loadPdfAndInitFlipbook);
    </script>
</body>
</html>
